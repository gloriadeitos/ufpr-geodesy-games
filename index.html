<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Passatempo Geodésico</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .geodesic-header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .game-card {
            transition: transform 0.3s, box-shadow 0.3s;
            margin-bottom: 20px;
            border-radius: 10px;
            overflow: hidden;
            border: none;
            height: 100%;
        }
        .game-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .card-header {
            background-color: #2a5298;
            color: white;
            font-weight: bold;
        }
        .quiz-container {
            background-color: white;
            border-radius: 10px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        .wordsearch-container {
            background-color: white;
            border-radius: 10px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        .question {
            font-weight: 600;
            margin-bottom: 1.5rem;
        }
        .option {
            padding: 10px 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            border: 1px solid #dee2e6;
        }
        .option:hover {
            background-color: #f1f3f5;
        }
        .option.selected {
            background-color: #d1e7ff;
            border-color: #86b7fe;
        }
        .option.correct {
            background-color: #d1fae5;
            border-color: #34d399;
        }
        .option.incorrect {
            background-color: #fee2e2;
            border-color: #f87171;
        }
        .feedback {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 5px;
            display: none;
        }
        .feedback.correct {
            background-color: #d1fae5;
            color: #065f46;
        }
        .feedback.incorrect {
            background-color: #fee2e2;
            color: #b91c1c;
        }
        .progress-container {
            margin-bottom: 2rem;
        }
        .progress {
            height: 10px;
        }
        .result-container {
            display: none;
            text-align: center;
            padding: 2rem;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .result-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }
        .btn-geodesic {
            background-color: #2a5298;
            color: white;
            border: none;
            padding: 0.5rem 1.5rem;
            border-radius: 50px;
            transition: all 0.3s;
        }
        .btn-geodesic:hover {
            background-color: #1e3c72;
            color: white;
            transform: translateY(-2px);
        }
        .btn-geodesic-outline {
            background-color: transparent;
            color: #2a5298;
            border: 2px solid #2a5298;
            padding: 0.5rem 1.5rem;
            border-radius: 50px;
            transition: all 0.3s;
        }
        .btn-geodesic-outline:hover {
            background-color: #2a5298;
            color: white;
        }
        .icon-feature {
            font-size: 2.5rem;
            color: #2a5298;
            margin-bottom: 1rem;
        }
        .feature-card {
            text-align: center;
            padding: 1.5rem;
            border-radius: 10px;
            height: 100%;
            background-color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .download-section {
            background-color: #e9f5ff;
            padding: 2rem;
            border-radius: 10px;
            margin-top: 2rem;
        }
        /* Word Search Styles */
        #wordsearch-board {
            display: grid;
            grid-template-columns: repeat(15, 1fr);
            gap: 1px;
            margin: 20px auto;
            background-color: #ddd;
            border: 2px solid #2a5298;
            touch-action: none; /* Para melhorar o arrastar em dispositivos móveis */
        }
        .wordsearch-cell {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: white;
            font-weight: bold;
            cursor: pointer;
            user-select: none;
        }
        .wordsearch-cell.selected {
            background-color: #d1e7ff;
        }
        .wordsearch-cell.found {
            background-color: #d1fae5;
        }
        #wordsearch-words {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        .wordsearch-word {
            padding: 5px 10px;
            background-color: #f1f3f5;
            border-radius: 5px;
        }
        .wordsearch-word.found {
            background-color: #d1fae5;
            text-decoration: line-through;
        }
        .wordsearch-topic-selector {
            margin-bottom: 20px;
        }
        .wordsearch-instructions {
            margin-bottom: 20px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="geodesic-header">
        <div class="container text-center">
            <h1><i class="fas fa-globe-americas"></i> Passatempo Geodésico</h1>
            <p class="lead">Teste seus conhecimentos em Geodésia e Sistemas de Referência</p>
        </div>
    </header>

    <div class="container">
        <!-- Game Selection -->
        <div class="row mb-4" id="game-selection">
            <div class="col-12 mb-4">
                <h2 class="text-center mb-4">Escolha seu desafio</h2>
            </div>
            
            <div class="col-md-3 mb-4">
                <div class="game-card card h-100">
                    <div class="card-header">
                        <i class="fas fa-search"></i> Caça-Palavras
                    </div>
                    <div class="card-body">
                        <p class="card-text">Encontre termos geodésicos escondidos em uma grade de letras.</p>
                        <button class="btn btn-geodesic w-100" id="start-wordsearch">Iniciar Jogo</button>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3 mb-4">
                <div class="game-card card h-100">
                    <div class="card-header">
                        <i class="fas fa-crosshairs"></i> Conceitos Básicos
                    </div>
                    <div class="card-body">
                        <p class="card-text">Teste seus conhecimentos sobre os fundamentos da Geodésia.</p>
                        <button class="btn btn-geodesic w-100 start-quiz" data-quiz="basic">Iniciar Quiz</button>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3 mb-4">
                <div class="game-card card h-100">
                    <div class="card-header">
                        <i class="fas fa-vector-square"></i> Sistemas Cartesianos
                    </div>
                    <div class="card-body">
                        <p class="card-text">Desafie-se com questões sobre sistemas 2D e 3D.</p>
                        <button class="btn btn-geodesic w-100 start-quiz" data-quiz="cartesian">Iniciar Quiz</button>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3 mb-4">
                <div class="game-card card h-100">
                    <div class="card-header">
                        <i class="fas fa-globe"></i> Terra Esférica
                    </div>
                    <div class="card-body">
                        <p class="card-text">Questões sobre trigonometria esférica e posicionamento.</p>
                        <button class="btn btn-geodesic w-100 start-quiz" data-quiz="spherical">Iniciar Quiz</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Word Search Container -->
        <div id="wordsearch-container" class="wordsearch-container" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="mb-0"><i class="fas fa-search"></i> Caça-Palavras Geodésico</h3>
                <div>
                    <button id="wordsearch-download" class="btn btn-geodesic-outline me-2">
                        <i class="fas fa-download"></i> Baixar
                    </button>
                    <button id="wordsearch-back" class="btn btn-geodesic-outline">
                        <i class="fas fa-arrow-left"></i> Voltar
                    </button>
                </div>
            </div>
            
            <div class="wordsearch-topic-selector">
                <label for="wordsearch-topic" class="form-label">Selecione o tema:</label>
                <select id="wordsearch-topic" class="form-select">
                    <option value="">Escolha um tema...</option>
                    <option value="basic">Conceitos Básicos</option>
                    <option value="cartesian">Sistemas Cartesianos</option>
                    <option value="spherical">Terra Esférica</option>
                    <option value="all">Todos os Temas</option>
                </select>
            </div>
            
            <div class="wordsearch-instructions">
                <i class="fas fa-info-circle"></i> Clique e arraste para selecionar as palavras. Elas podem estar na horizontal, vertical ou diagonal.
            </div>
            
            <div id="wordsearch-placeholder" class="text-center py-5" style="background-color: #f8f9fa; border-radius: 10px; border: 2px dashed #dee2e6;">
                <i class="fas fa-arrow-up text-muted" style="font-size: 2rem;"></i>
                <p class="text-muted mt-3 mb-0">Selecione um tema acima para começar o caça-palavras</p>
            </div>
            
            <div id="wordsearch-content" style="display: none;">
                <div id="wordsearch-words"></div>
                <div id="wordsearch-board"></div>
            </div>
            
            <div class="d-flex justify-content-between mt-4">
                <button id="wordsearch-reset" class="btn btn-geodesic-outline" disabled>
                    <i class="fas fa-redo"></i> Reiniciar
                </button>
            </div>
        </div>

        <!-- Quiz Container -->
        <div id="quiz-container" class="quiz-container" style="display: none;">
            <div class="progress-container">
                <div class="d-flex justify-content-between mb-2">
                    <span id="question-counter">Pergunta 1 de 10</span>
                    <span id="score-counter">Pontuação: 0</span>
                </div>
                <div class="progress">
                    <div id="quiz-progress" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
                </div>
            </div>
            
            <div id="question-container">
                <div class="question" id="question-text">Carregando pergunta...</div>
                <div id="options-container">
                    <!-- Options will be inserted here by JavaScript -->
                </div>
                <div id="feedback" class="feedback"></div>
            </div>
            
            <div class="d-flex justify-content-between mt-4">
                <button id="prev-btn" class="btn btn-geodesic-outline" disabled>
                    <i class="fas fa-arrow-left"></i> Anterior
                </button>
                <button id="next-btn" class="btn btn-geodesic">
                    Próxima <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- Result Container -->
        <div id="result-container" class="result-container">
            <div id="result-icon" class="result-icon text-success">
                <i class="fas fa-trophy"></i>
            </div>
            <h2 id="result-title">Parabéns!</h2>
            <p id="result-message">Você completou o quiz com sucesso!</p>
            <p id="result-score" class="h4 mb-4">Sua pontuação: <span class="fw-bold">0</span>/10</p>
            <div class="d-flex justify-content-center gap-3">
                <button id="restart-btn" class="btn btn-geodesic">
                    <i class="fas fa-redo"></i> Jogar Novamente
                </button>
                <button id="download-pdf-btn" class="btn btn-geodesic-outline">
                    <i class="fas fa-file-pdf"></i> Baixar PDF
                </button>
                <button id="download-questions-pdf-btn" class="btn btn-geodesic-outline">
                    <i class="fas fa-file-alt"></i> Somente Perguntas
                </button>
                <button id="back-to-menu-btn" class="btn btn-geodesic-outline">
                    <i class="fas fa-home"></i> Menu Principal
                </button>
            </div>
        </div>

        <!-- Features Section -->
        <div class="row mt-5">
            <div class="col-12 mb-4">
                <h2 class="text-center">Como funciona o jogo</h2>
            </div>
            
            <div class="col-md-4 mb-4">
                <div class="feature-card">
                    <div class="icon-feature">
                        <i class="fas fa-book-open"></i>
                    </div>
                    <h4>Baseado no Conteúdo</h4>
                    <p>Perguntas elaboradas a partir dos materiais de Geodésia e Sistemas de Referência da UFPR.</p>
                </div>
            </div>
            
            <div class="col-md-4 mb-4">
                <div class="feature-card">
                    <div class="icon-feature">
                        <i class="fas fa-brain"></i>
                    </div>
                    <h4>Teste seu Conhecimento</h4>
                    <p>Desafie-se com questões sobre conceitos fundamentais e aplicações práticas.</p>
                </div>
            </div>
            
            <div class="col-md-4 mb-4">
                <div class="feature-card">
                    <div class="icon-feature">
                        <i class="fas fa-download"></i>
                    </div>
                    <h4>Material para Download</h4>
                    <p>Baixe PDFs com perguntas, respostas ou apenas as perguntas para estudo offline.</p>
                </div>
            </div>
        </div>

        <!-- Download Section -->
        <div class="download-section">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h3><i class="fas fa-file-pdf"></i> Baixe o material completo</h3>
                    <p>Quer estudar offline? Baixe PDFs com todas as perguntas, com ou sem respostas, e o caça-palavras.</p>
                </div>
                <div class="col-md-4 text-md-end">
                    <div class="btn-group">
                        <button id="download-full-pdf" class="btn btn-geodesic">
                            <i class="fas fa-download"></i> PDF Completo
                        </button>
                        <button id="download-questions-only" class="btn btn-geodesic-outline">
                            <i class="fas fa-file-alt"></i> Somente Perguntas
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-light py-4 mt-5">
        <div class="container text-center">
            <p class="mb-0">Passatempo Geodésico - Disciplina de Geodésia - UFPR</p>
            <p class="text-muted small mb-0">Desenvolvido para fins educacionais</p>
        </div>
    </footer>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- jsPDF AutoTable for tables in PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script>
        // Initialize jsPDF
        const { jsPDF } = window.jspdf;
        
        // Quiz data based on the PDF content
        const quizzes = {
            basic: {
                title: "Conceitos Básicos de Geodésia",
                questions: [
                    {
                        question: "Qual é a definição original do metro baseada em Geodésia?",
                        options: [
                            "1/10.000.000 da distância do equador ao polo norte medida no meridiano de Paris",
                            "Comprimento do trajeto percorrido pela luz no vácuo durante 1/299792458 do segundo",
                            "Distância entre duas marcas em uma barra de platina-irídio",
                            "1/40.000.000 da circunferência da Terra"
                        ],
                        answer: 0,
                        explanation: "A definição original do metro (século XVIII) era baseada em Geodésia, como 1/10.000.000 do quadrante de meridiano da Terra (distância do equador ao polo norte medida no meridiano de Paris)."
                    },
                    {
                        question: "Qual é a diferença entre um sistema dextrogiro e levogiro?",
                        options: [
                            "Dextrogiro segue a regra da mão direita, levogiro da mão esquerda",
                            "Dextrogiro tem eixo Z para cima, levogiro para baixo",
                            "Dextrogiro usa metros, levogiro usa pés",
                            "Não há diferença, são termos intercambiáveis"
                        ],
                        answer: 0,
                        explanation: "Um sistema dextrogiro segue a regra da mão direita: se você curvar os dedos da mão direita do eixo X para o Y, o polegar apontará para o eixo Z positivo. O levogiro segue a regra da mão esquerda."
                    },
                    {
                        question: "Qual é o valor de 1 hectare em metros quadrados?",
                        options: [
                            "10.000 m²",
                            "1.000 m²",
                            "100 m²",
                            "1 m²"
                        ],
                        answer: 0,
                        explanation: "1 hectare equivale a 10.000 m² (100m x 100m). É uma unidade de área comumente usada em medições de terrenos."
                    },
                    {
                        question: "Qual destes NÃO é um tipo de norte mencionado nos materiais?",
                        options: [
                            "Norte astronômico",
                            "Norte geodésico",
                            "Norte magnético",
                            "Norte de quadrícula"
                        ],
                        answer: 0,
                        explanation: "Os tipos de norte mencionados são: geodésico (verdadeiro), magnético, de quadrícula e topográfico (local/arbitrário). Norte astronômico não foi especificamente mencionado."
                    },
                    {
                        question: "Qual é a fórmula para calcular a distância horizontal entre dois pontos em coordenadas cartesianas 2D?",
                        options: [
                            "√[(X₂-X₁)² + (Y₂-Y₁)²]",
                            "(X₂-X₁) + (Y₂-Y₁)",
                            "√[(X₂+X₁)² - (Y₂+Y₁)²]",
                            "(X₂² + Y₂²) - (X₁² + Y₁²)"
                        ],
                        answer: 0,
                        explanation: "A distância horizontal (ou distância euclidiana no plano) entre dois pontos 1 e 2 é calculada por dh₁₂ = √[(X₂-X₁)² + (Y₂-Y₁)²], que vem do teorema de Pitágoras."
                    }
                ]
            },
            cartesian: {
                title: "Sistemas Cartesianos",
                questions: [
                    {
                        question: "Em um sistema cartesiano tridimensional geodésico, qual eixo normalmente coincide com o eixo de rotação da Terra?",
                        options: [
                            "Eixo Z",
                            "Eixo X",
                            "Eixo Y",
                            "Nenhum dos eixos"
                        ],
                        answer: 0,
                        explanation: "No sistema cartesiano tridimensional geodésico, o eixo Z é fixado na direção do eixo de rotação da Terra, positivo para o Polo Norte (PN)."
                    },
                    {
                        question: "Qual é a sequência correta de transformações na fórmula de Bursa-Wolf?",
                        options: [
                            "Escala → Rotação → Translação",
                            "Translação → Rotação → Escala",
                            "Rotação → Translação → Escala",
                            "Escala → Translação → Rotação"
                        ],
                        answer: 0,
                        explanation: "O modelo de transformação Bursa-Wolf segue a sequência: (1 + δ) para escala, depois rotação (R₃(εz)R₂(εy)R₁(εx)), e finalmente translação (x₀,y₀,z₀)."
                    },
                    {
                        question: "Qual matriz representa uma rotação de θ graus em torno do eixo Z?",
                        options: [
                            "[cosθ sinθ 0; -sinθ cosθ 0; 0 0 1]",
                            "[1 0 0; 0 cosθ sinθ; 0 -sinθ cosθ]",
                            "[cosθ 0 -sinθ; 0 1 0; sinθ 0 cosθ]",
                            "[cosθ -sinθ 0; sinθ cosθ 0; 0 0 1]"
                        ],
                        answer: 0,
                        explanation: "A matriz de rotação em torno do eixo Z é R₃(θ) = [cosθ sinθ 0; -sinθ cosθ 0; 0 0 1]. Note que a rotação é positiva no sentido anti-horário (dextrogiro)."
                    },
                    {
                        question: "Como se converte coordenadas polares (Az, di, Z) para cartesianas 3D?",
                        options: [
                            "X = di·senZ·senAz; Y = di·senZ·cosAz; Z = di·cosZ",
                            "X = di·cosZ·cosAz; Y = di·cosZ·senAz; Z = di·senZ",
                            "X = di·cosAz; Y = di·senAz; Z = di·tanZ",
                            "X = di·senAz; Y = di·cosAz; Z = di"
                        ],
                        answer: 0,
                        explanation: "As fórmulas de conversão são: X = di·senZ·senAz; Y = di·senZ·cosAz; Z = di·cosZ, onde di é distância inclinada, Z é ângulo zenital e Az é azimute."
                    },
                    {
                        question: "Qual é a principal característica de uma transformação de Helmert (similaridade)?",
                        options: [
                            "Preserva ângulos mas não tamanhos",
                            "Preserva tamanhos mas não ângulos",
                            "Não preserva nem ângulos nem tamanhos",
                            "Preserva tanto ângulos quanto tamanhos"
                        ],
                        answer: 0,
                        explanation: "A transformação de Helmert (ou de similaridade) preserva ângulos (é isogonal) mas não preserva tamanhos, pois inclui um fator de escala uniforme."
                    }
                ]
            },
            spherical: {
                title: "Terra Esférica",
                questions: [
                    {
                        question: "Qual é a definição de um círculo máximo na Terra esférica?",
                        options: [
                            "Circunferência que contém o centro da esfera",
                            "Circunferência paralela ao equador",
                            "Circunferência com raio igual ao da Terra",
                            "Circunferência que passa pelos polos"
                        ],
                        answer: 0,
                        explanation: "Um círculo máximo (ou circunferência máxima) é qualquer circunferência na superfície esférica que contém o centro da esfera. Exemplos: equador e meridianos."
                    },
                    {
                        question: "Como se calcula o raio de um paralelo (Rₚ) em função da latitude (φ)?",
                        options: [
                            "Rₚ = R·cosφ",
                            "Rₚ = R·senφ",
                            "Rₚ = R·tanφ",
                            "Rₚ = R/cosφ"
                        ],
                        answer: 0,
                        explanation: "O raio de um paralelo diminui conforme aumenta a latitude: Rₚ = R·cosφ, onde R é o raio da Terra e φ é a latitude geográfica."
                    },
                    {
                        question: "Qual é a característica principal de uma linha loxodrômica?",
                        options: [
                            "Mantém um ângulo constante com todos os meridianos",
                            "Representa a menor distância entre dois pontos",
                            "Sempre cruza os meridianos a 90 graus",
                            "É um círculo máximo"
                        ],
                        answer: 0,
                        explanation: "A loxodrômica é uma linha na superfície terrestre que faz um ângulo constante (rumo/azimute) com todos os meridianos, tendo formato de espiral."
                    },
                    {
                        question: "Qual é a distância esférica (d) entre dois pontos A e B na Terra esférica?",
                        options: [
                            "d = arccos[senφₐ·senφᵦ + cosφₐ·cosφᵦ·cosΔλ]",
                            "d = √[senφₐ·senφᵦ + cosφₐ·cosφᵦ·cosΔλ]",
                            "d = R·[senφₐ + senφᵦ + cosΔλ]",
                            "d = R·arccos[φₐ - φᵦ + Δλ]"
                        ],
                        answer: 0,
                        explanation: "A distância esférica (arco de circunferência máxima) é calculada por: cos(d) = senφₐ·senφᵦ + cosφₐ·cosφᵦ·cosΔλ, onde Δλ = λᵦ - λₐ."
                    },
                    {
                        question: "Como Eratóstenes calculou o raio da Terra em 200 a.C.?",
                        options: [
                            "Medindo sombras em duas cidades no solstício",
                            "Observando navios desaparecerem no horizonte",
                            "Calculando a curvatura em eclipses lunares",
                            "Medindo o tempo de viagem entre cidades"
                        ],
                        answer: 0,
                        explanation: "Eratóstenes comparou a sombra de uma vareta em Alexandria com a ausência de sombra em Siena (Assuã) no solstício, calculando o raio terrestre com impressionante precisão."
                    }
                ]
            }
        };

        // Word search data
        const wordSearchData = {
            basic: {
                title: "Conceitos Básicos",
                words: ["METRO", "GEODESIA", "NORTE", "AZIMUTE", "DISTANCIA", "ANGULO", "SISTEMA", "COORDENADA", "ALTURA", "PLANIMETRIA"],
                description: "Termos básicos de Geodésia e Topografia"
            },
            cartesian: {
                title: "Sistemas Cartesianos",
                words: ["DEXTROGIRO", "LEVOGIRO", "TRANSFORMACAO", "ROTACAO", "TRANSLACAO", "ESCALA", "HELMERT", "BURSAWOLF", "MATRIZ", "VETOR"],
                description: "Termos sobre sistemas de coordenadas e transformações"
            },
            spherical: {
                title: "Terra Esférica",
                words: ["ESFERA", "MERIDIANO", "PARALELO", "EQUADOR", "LOXODROMICA", "ORTODROMICA", "LATITUDE", "LONGITUDE", "RAIO", "ERATOSTENES"],
                description: "Termos sobre o modelo esférico da Terra"
            },
            all: {
                title: "Todos os Temas",
                words: ["GEODESIA", "METRO", "NORTE", "AZIMUTE", "DEXTROGIRO", "ROTACAO", "ESFERA", "MERIDIANO", "LATITUDE", "LONGITUDE"],
                description: "Termos mistos de todos os temas"
            }
        };

        // Game state variables
        let currentQuiz = null;
        let currentQuestion = 0;
        let score = 0;
        let userAnswers = [];
        let quizData = [];
        let wordSearchGame = null;

        // DOM elements
        const gameSelection = document.getElementById('game-selection');
        const quizContainer = document.getElementById('quiz-container');
        const questionText = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const feedbackDiv = document.getElementById('feedback');
        const questionCounter = document.getElementById('question-counter');
        const scoreCounter = document.getElementById('score-counter');
        const quizProgress = document.getElementById('quiz-progress');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const resultContainer = document.getElementById('result-container');
        const resultTitle = document.getElementById('result-title');
        const resultMessage = document.getElementById('result-message');
        const resultScore = document.getElementById('result-score');
        const resultIcon = document.getElementById('result-icon');
        const restartBtn = document.getElementById('restart-btn');
        const downloadPdfBtn = document.getElementById('download-pdf-btn');
        const backToMenuBtn = document.getElementById('back-to-menu-btn');
        const downloadQuestionsPdfBtn = document.getElementById('download-questions-pdf-btn');
        const downloadFullPdf = document.getElementById('download-full-pdf');
        const downloadQuestionsOnly = document.getElementById('download-questions-only');
        const startWordsearchBtn = document.getElementById('start-wordsearch');
        const wordsearchContainer = document.getElementById('wordsearch-container');
        const wordsearchBackBtn = document.getElementById('wordsearch-back');
        const wordsearchTopicSelect = document.getElementById('wordsearch-topic');
        const wordsearchWordsDiv = document.getElementById('wordsearch-words');
        const wordsearchBoard = document.getElementById('wordsearch-board');
        const wordsearchResetBtn = document.getElementById('wordsearch-reset');
        const wordsearchDownloadBtn = document.getElementById('wordsearch-download');

        // Start quiz buttons
        document.querySelectorAll('.start-quiz').forEach(button => {
            button.addEventListener('click', function() {
                currentQuiz = this.getAttribute('data-quiz');
                startQuiz(currentQuiz);
            });
        });

        // Start word search game
        startWordsearchBtn.addEventListener('click', function() {
            gameSelection.style.display = 'none';
            quizContainer.style.display = 'none';
            resultContainer.style.display = 'none';
            wordsearchContainer.style.display = 'block';
            
            // Reset topic selector and show placeholder
            wordsearchTopicSelect.value = '';
            document.getElementById('wordsearch-placeholder').style.display = 'block';
            document.getElementById('wordsearch-content').style.display = 'none';
            wordsearchResetBtn.disabled = true;
            wordsearchDownloadBtn.disabled = true;
        });

        // Back button from word search
        wordsearchBackBtn.addEventListener('click', function() {
            wordsearchContainer.style.display = 'none';
            gameSelection.style.display = 'flex';
        });

        // Word search topic change
        wordsearchTopicSelect.addEventListener('change', function() {
            const selectedTopic = this.value;
            
            if (selectedTopic === '') {
                // Show placeholder if no topic selected
                document.getElementById('wordsearch-placeholder').style.display = 'block';
                document.getElementById('wordsearch-content').style.display = 'none';
                wordsearchResetBtn.disabled = true;
                wordsearchDownloadBtn.disabled = true;
            } else {
                // Hide placeholder and show game
                document.getElementById('wordsearch-placeholder').style.display = 'none';
                document.getElementById('wordsearch-content').style.display = 'block';
                wordsearchResetBtn.disabled = false;
                wordsearchDownloadBtn.disabled = false;
                
                // Initialize game with selected topic
                initWordSearch(selectedTopic);
            }
        });

        // Word search reset button
        wordsearchResetBtn.addEventListener('click', function() {
            if (wordSearchGame && wordsearchTopicSelect.value) {
                wordSearchGame.resetSelection();
                initWordSearch(wordsearchTopicSelect.value);
            }
        });

        // Word search download button
        wordsearchDownloadBtn.addEventListener('click', function() {
            if (wordsearchTopicSelect.value) {
                generateWordSearchPdf(wordsearchTopicSelect.value, false);
            }
        });

        // Start a new quiz
        function startQuiz(quizType) {
            currentQuestion = 0;
            score = 0;
            userAnswers = [];
            quizData = quizzes[quizType].questions;
            
            gameSelection.style.display = 'none';
            quizContainer.style.display = 'block';
            wordsearchContainer.style.display = 'none';
            resultContainer.style.display = 'none';
            
            updateQuestionCounter();
            updateScore();
            loadQuestion();
        }

        // Load the current question
        function loadQuestion() {
            const question = quizData[currentQuestion];
            questionText.textContent = question.question;
            
            optionsContainer.innerHTML = '';
            question.options.forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'option';
                if (userAnswers[currentQuestion] !== undefined && userAnswers[currentQuestion] === index) {
                    optionDiv.classList.add('selected');
                }
                optionDiv.textContent = option;
                optionDiv.addEventListener('click', () => selectOption(index));
                optionsContainer.appendChild(optionDiv);
            });
            
            // Hide feedback when loading new question
            feedbackDiv.style.display = 'none';
            feedbackDiv.className = 'feedback';
            feedbackDiv.innerHTML = '';
            
            // Update button states
            prevBtn.disabled = currentQuestion === 0;
            nextBtn.textContent = currentQuestion === quizData.length - 1 ? 'Finalizar' : 'Próxima';
            
            // If user already answered this question, show feedback
            if (userAnswers[currentQuestion] !== undefined) {
                showFeedback();
            }
        }

        // Select an option
        function selectOption(index) {
            // Remove selected class from all options
            document.querySelectorAll('.option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Add selected class to clicked option
            document.querySelectorAll('.option')[index].classList.add('selected');
            
            // Store user's answer
            userAnswers[currentQuestion] = index;
            
            // Show feedback immediately
            showFeedback();
        }

        // Show feedback for the current question
        function showFeedback() {
            const question = quizData[currentQuestion];
            const userAnswer = userAnswers[currentQuestion];
            
            // Remove all feedback classes
            feedbackDiv.className = 'feedback';
            
            if (userAnswer !== undefined) {
                // Mark correct and incorrect answers
                document.querySelectorAll('.option').forEach((option, index) => {
                    if (index === question.answer) {
                        option.classList.add('correct');
                    } else if (index === userAnswer && index !== question.answer) {
                        option.classList.add('incorrect');
                    }
                });
                
                // Show feedback message
                feedbackDiv.style.display = 'block';
                if (userAnswer === question.answer) {
                    feedbackDiv.classList.add('correct');
                    feedbackDiv.innerHTML = `<i class="fas fa-check-circle"></i> Correto! ${question.explanation}`;
                } else {
                    feedbackDiv.classList.add('incorrect');
                    feedbackDiv.innerHTML = `<i class="fas fa-times-circle"></i> Incorreto. A resposta correta é: ${question.options[question.answer]}. ${question.explanation}`;
                }
            }
        }

        // Navigate to previous question
        prevBtn.addEventListener('click', () => {
            if (currentQuestion > 0) {
                currentQuestion--;
                loadQuestion();
            }
        });

        // Navigate to next question or finish quiz
        nextBtn.addEventListener('click', () => {
            // Check if current question was answered
            if (userAnswers[currentQuestion] === undefined) {
                alert('Por favor, selecione uma resposta antes de continuar.');
                return;
            }
            
            // Update score if moving forward to a new question
            if (currentQuestion === quizData.length - 1) {
                finishQuiz();
            } else {
                currentQuestion++;
                loadQuestion();
            }
        });

        // Finish the quiz and show results
        function finishQuiz() {
            // Calculate final score
            score = 0;
            userAnswers.forEach((answer, index) => {
                if (answer === quizData[index].answer) {
                    score++;
                }
            });
            
            // Show result container
            quizContainer.style.display = 'none';
            resultContainer.style.display = 'block';
            
            // Set result message based on score
            resultScore.innerHTML = `Sua pontuação: <span class="fw-bold">${score}</span>/${quizData.length}`;
            
            if (score === quizData.length) {
                resultTitle.textContent = 'Excelente!';
                resultMessage.textContent = 'Você acertou todas as perguntas! Dominou completamente o assunto.';
                resultIcon.className = 'result-icon text-success';
                resultIcon.innerHTML = '<i class="fas fa-trophy"></i>';
            } else if (score >= quizData.length * 0.7) {
                resultTitle.textContent = 'Muito bom!';
                resultMessage.textContent = 'Você demonstrou um bom conhecimento do assunto, mas ainda pode melhorar.';
                resultIcon.className = 'result-icon text-primary';
                resultIcon.innerHTML = '<i class="fas fa-thumbs-up"></i>';
            } else if (score >= quizData.length * 0.5) {
                resultTitle.textContent = 'Bom esforço!';
                resultMessage.textContent = 'Você acertou mais da metade, mas precisa revisar alguns conceitos.';
                resultIcon.className = 'result-icon text-warning';
                resultIcon.innerHTML = '<i class="fas fa-book-open"></i>';
            } else {
                resultTitle.textContent = 'Continue estudando!';
                resultMessage.textContent = 'Você precisa revisar os conceitos básicos. Não desanime!';
                resultIcon.className = 'result-icon text-danger';
                resultIcon.innerHTML = '<i class="fas fa-redo"></i>';
            }
        }

        // Update question counter
        function updateQuestionCounter() {
            questionCounter.textContent = `Pergunta ${currentQuestion + 1} de ${quizData.length}`;
            const progress = ((currentQuestion + 1) / quizData.length) * 100;
            quizProgress.style.width = `${progress}%`;
        }

        // Update score counter
        function updateScore() {
            let currentScore = 0;
            for (let i = 0; i <= currentQuestion; i++) {
                if (userAnswers[i] !== undefined && userAnswers[i] === quizData[i].answer) {
                    currentScore++;
                }
            }
            scoreCounter.textContent = `Pontuação: ${currentScore}`;
        }

        // Restart quiz button
        restartBtn.addEventListener('click', () => {
            startQuiz(currentQuiz);
        });

        // Back to menu button
        backToMenuBtn.addEventListener('click', () => {
            gameSelection.style.display = 'flex';
            quizContainer.style.display = 'none';
            resultContainer.style.display = 'none';
            wordsearchContainer.style.display = 'none';
        });

        // Download PDF buttons
        downloadPdfBtn.addEventListener('click', generateResultsPdf);
        downloadQuestionsPdfBtn.addEventListener('click', generateQuestionsOnlyPdf);
        downloadFullPdf.addEventListener('click', generateFullContentPdf);
        downloadQuestionsOnly.addEventListener('click', generateAllQuestionsOnlyPdf);

        // Generate PDF with quiz results
        function generateResultsPdf() {
            const doc = new jsPDF();
            
            // Adiciona suporte a caracteres especiais
            doc.setFont('helvetica', 'normal');
            
            // Title
            doc.setFontSize(18);
            doc.setTextColor(42, 82, 152);
            doc.text('Resultados do Quiz Geodésico', 105, 20, { align: 'center' });
            
            doc.setFontSize(14);
            doc.setTextColor(0, 0, 0);
            doc.text(quizzes[currentQuiz].title, 105, 30, { align: 'center' });
            
            // Score
            doc.setFontSize(12);
            doc.text('Pontuação: ' + score + ' de ' + quizData.length, 105, 40, { align: 'center' });
            
            // Date
            const today = new Date();
            doc.text('Data: ' + today.toLocaleDateString('pt-BR'), 105, 50, { align: 'center' });
            
            // Add line
            doc.setDrawColor(42, 82, 152);
            doc.setLineWidth(0.5);
            doc.line(20, 55, 190, 55);
            
            // Questions and answers
            let yPos = 65;
            
            quizData.forEach((question, index) => {
                // Check if we need a new page
                if (yPos > 250) {
                    doc.addPage();
                    yPos = 20;
                }
                
                // Question
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(0, 0, 0);
                
                const cleanQuestion = (index + 1) + '. ' + question.question;
                const questionLines = doc.splitTextToSize(cleanQuestion, 170);
                doc.text(questionLines, 20, yPos);
                yPos += questionLines.length * 6 + 5;
                
                // User's answer
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                const userAnswer = userAnswers[index];
                const isCorrect = userAnswer === question.answer;
                
                doc.setTextColor(isCorrect ? 0 : 200, isCorrect ? 150 : 0, 0);
                const cleanUserAnswer = 'Sua resposta: ' + question.options[userAnswer];
                const userAnswerLines = doc.splitTextToSize(cleanUserAnswer, 165);
                doc.text(userAnswerLines, 25, yPos);
                yPos += userAnswerLines.length * 5 + 3;
                
                // Correct answer if wrong
                if (!isCorrect) {
                    doc.setTextColor(0, 150, 0);
                    const cleanCorrectAnswer = 'Resposta correta: ' + question.options[question.answer];
                    const correctAnswerLines = doc.splitTextToSize(cleanCorrectAnswer, 165);
                    doc.text(correctAnswerLines, 25, yPos);
                    yPos += correctAnswerLines.length * 5 + 3;
                }
                
                // Explanation
                doc.setTextColor(60, 60, 60);
                const cleanExplanation = 'Explicação: ' + question.explanation;
                const explanationLines = doc.splitTextToSize(cleanExplanation, 165);
                doc.text(explanationLines, 25, yPos);
                yPos += explanationLines.length * 5 + 10;
            });
            
            // Save the PDF
            doc.save('Resultados_Geodesia_' + currentQuiz + '.pdf');
        }

        // Generate PDF with questions only
        function generateQuestionsOnlyPdf() {
            const doc = new jsPDF();
            
            // Adiciona suporte a caracteres especiais
            doc.setFont('helvetica', 'normal');
            
            // Title
            doc.setFontSize(18);
            doc.setTextColor(42, 82, 152);
            doc.text('Perguntas do Quiz Geodésico', 105, 20, { align: 'center' });
            
            doc.setFontSize(14);
            doc.setTextColor(0, 0, 0);
            doc.text(quizzes[currentQuiz].title, 105, 30, { align: 'center' });
            
            // Date
            const today = new Date();
            doc.setFontSize(10);
            doc.text('Data: ' + today.toLocaleDateString('pt-BR'), 105, 40, { align: 'center' });
            
            // Add line
            doc.setDrawColor(42, 82, 152);
            doc.setLineWidth(0.5);
            doc.line(20, 45, 190, 45);
            
            // Questions
            let yPos = 55;
            
            quizData.forEach((question, index) => {
                // Check if we need a new page
                if (yPos > 230) {
                    doc.addPage();
                    yPos = 20;
                }
                
                // Question
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(0, 0, 0);
                
                const cleanQuestion = (index + 1) + '. ' + question.question;
                const questionLines = doc.splitTextToSize(cleanQuestion, 170);
                doc.text(questionLines, 20, yPos);
                yPos += questionLines.length * 6 + 5;
                
                // Options
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                question.options.forEach((option, optIndex) => {
                    const letter = String.fromCharCode(97 + optIndex); // a, b, c, d
                    const cleanOption = letter + ') ' + option;
                    const optionLines = doc.splitTextToSize(cleanOption, 160);
                    doc.text(optionLines, 25, yPos);
                    yPos += optionLines.length * 5 + 2;
                });
                
                // Space for answer
                yPos += 5;
                doc.setTextColor(100, 100, 100);
                doc.text('Resposta: _____', 25, yPos);
                doc.setTextColor(0, 0, 0);
                yPos += 15;
            });
            
            // Save the PDF
            doc.save('Perguntas_Geodesia_' + currentQuiz + '.pdf');
        }

        // Generate PDF with full content
        function generateFullContentPdf() {
            const doc = new jsPDF();
            
            // Adiciona suporte a caracteres especiais
            doc.setFont('helvetica', 'normal');
            
            // Title
            doc.setFontSize(18);
            doc.setTextColor(42, 82, 152);
            doc.text('Material Completo de Geodésia', 105, 20, { align: 'center' });
            
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text('Baseado nos conteúdos da UFPR', 105, 30, { align: 'center' });
            
            // Date
            const today = new Date();
            doc.setFontSize(10);
            doc.text('Data: ' + today.toLocaleDateString('pt-BR'), 105, 40, { align: 'center' });
            
            // Add line
            doc.setDrawColor(42, 82, 152);
            doc.setLineWidth(0.5);
            doc.line(20, 45, 190, 45);
            
            // Introduction
            let yPos = 55;
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            doc.text('Este material contém todas as perguntas e respostas dos quizzes sobre:', 20, yPos);
            yPos += 8;
            doc.text('- Conceitos Básicos de Geodésia', 25, yPos);
            yPos += 6;
            doc.text('- Sistemas Cartesianos', 25, yPos);
            yPos += 6;
            doc.text('- Terra Esférica', 25, yPos);
            yPos += 15;
            
            // Loop through all quizzes
            Object.keys(quizzes).forEach(quizKey => {
                const quiz = quizzes[quizKey];
                
                // Check if we need a new page for quiz title
                if (yPos > 250) {
                    doc.addPage();
                    yPos = 20;
                }
                
                // Quiz title
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(42, 82, 152);
                doc.text(quiz.title, 20, yPos);
                yPos += 12;
                
                // Questions
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(0, 0, 0);
                
                quiz.questions.forEach((question, index) => {
                    // Check if we need a new page
                    if (yPos > 220) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    // Question
                    doc.setFont('helvetica', 'bold');
                    const cleanQuestion = (index + 1) + '. ' + question.question;
                    const questionLines = doc.splitTextToSize(cleanQuestion, 170);
                    doc.text(questionLines, 20, yPos);
                    yPos += questionLines.length * 5 + 4;
                    
                    // Options
                    doc.setFont('helvetica', 'normal');
                    question.options.forEach((option, optIndex) => {
                        const letter = String.fromCharCode(97 + optIndex);
                        const marker = optIndex === question.answer ? 'CORRETA' : '';
                        const optionColor = optIndex === question.answer ? [0, 150, 0] : [0, 0, 0];
                        
                        doc.setTextColor(...optionColor);
                        const cleanOption = letter + ') ' + option + ' ' + marker;
                        const optionLines = doc.splitTextToSize(cleanOption, 160);
                        doc.text(optionLines, 25, yPos);
                        yPos += optionLines.length * 4 + 2;
                    });
                    
                    // Explanation
                    doc.setTextColor(60, 60, 60);
                    const cleanExplanation = 'Explicação: ' + question.explanation;
                    const explanationLines = doc.splitTextToSize(cleanExplanation, 165);
                    doc.text(explanationLines, 25, yPos);
                    yPos += explanationLines.length * 4 + 10;
                });
                
                // Add space between quizzes
                yPos += 8;
            });
            
            // Save the PDF
            doc.save('Material_Completo_Geodesia.pdf');
        }

        // Generate PDF with all questions only
        function generateAllQuestionsOnlyPdf() {
            const doc = new jsPDF();
            
            // Adiciona suporte a caracteres especiais
            doc.setFont('helvetica', 'normal');
            
            // Title
            doc.setFontSize(18);
            doc.setTextColor(42, 82, 152);
            doc.text('Perguntas de Geodésia para Estudo', 105, 20, { align: 'center' });
            
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text('Prática e revisão dos conceitos', 105, 30, { align: 'center' });
            
            // Date
            const today = new Date();
            doc.setFontSize(10);
            doc.text('Data: ' + today.toLocaleDateString('pt-BR'), 105, 40, { align: 'center' });
            
            // Add line
            doc.setDrawColor(42, 82, 152);
            doc.setLineWidth(0.5);
            doc.line(20, 45, 190, 45);
            
            // Introduction
            let yPos = 55;
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            doc.text('Este material contém todas as perguntas dos quizzes para prática:', 20, yPos);
            yPos += 8;
            doc.text('- Conceitos Básicos de Geodésia', 25, yPos);
            yPos += 6;
            doc.text('- Sistemas Cartesianos', 25, yPos);
            yPos += 6;
            doc.text('- Terra Esférica', 25, yPos);
            yPos += 15;
            
            // Loop through all quizzes
            Object.keys(quizzes).forEach(quizKey => {
                const quiz = quizzes[quizKey];
                
                // Check if we need a new page for quiz title
                if (yPos > 250) {
                    doc.addPage();
                    yPos = 20;
                }
                
                // Quiz title
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(42, 82, 152);
                doc.text(quiz.title, 20, yPos);
                yPos += 12;
                
                // Questions
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(0, 0, 0);
                
                quiz.questions.forEach((question, index) => {
                    // Check if we need a new page
                    if (yPos > 220) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    // Question
                    doc.setFont('helvetica', 'bold');
                    const cleanQuestion = (index + 1) + '. ' + question.question;
                    const questionLines = doc.splitTextToSize(cleanQuestion, 170);
                    doc.text(questionLines, 20, yPos);
                    yPos += questionLines.length * 5 + 4;
                    
                    // Options
                    doc.setFont('helvetica', 'normal');
                    question.options.forEach((option, optIndex) => {
                        const letter = String.fromCharCode(97 + optIndex);
                        const cleanOption = letter + ') ' + option;
                        const optionLines = doc.splitTextToSize(cleanOption, 160);
                        doc.text(optionLines, 25, yPos);
                        yPos += optionLines.length * 4 + 2;
                    });
                    
                    // Space for answer
                    yPos += 5;
                    doc.setTextColor(100, 100, 100);
                    doc.text('Resposta: _____', 25, yPos);
                    doc.setTextColor(0, 0, 0);
                    yPos += 15;
                });
                
                // Add space between quizzes
                yPos += 8;
            });
            
            // Save the PDF
            doc.save('Perguntas_Geodesia_Estudo.pdf');
        }

        // Generate Word Search PDF
        function generateWordSearchPdf(topic, withSolutions) {
            const data = wordSearchData[topic];
            const doc = new jsPDF();
            
            // Adiciona suporte a caracteres especiais
            doc.setFont('helvetica', 'normal');
            
            // Title
            doc.setFontSize(18);
            doc.setTextColor(42, 82, 152);
            doc.text('Caça-Palavras Geodésico', 105, 20, { align: 'center' });
            
            doc.setFontSize(14);
            doc.setTextColor(0, 0, 0);
            doc.text(data.title, 105, 30, { align: 'center' });
            
            // Date
            const today = new Date();
            doc.setFontSize(10);
            doc.text('Data: ' + today.toLocaleDateString('pt-BR'), 105, 40, { align: 'center' });
            
            // Instructions
            doc.setFontSize(10);
            doc.setTextColor(60, 60, 60);
            doc.text('Encontre as palavras na grade abaixo.', 105, 50, { align: 'center' });
            doc.text('Elas podem estar na horizontal, vertical ou diagonal.', 105, 57, { align: 'center' });
            
            // Words to find
            doc.setFontSize(11);
            doc.setTextColor(0, 0, 0);
            doc.text('Palavras para encontrar:', 20, 70);
            
            let xPos = 20;
            let yPos = 80;
            const wordsPerLine = 3;
            
            data.words.forEach((word, index) => {
                if (index > 0 && index % wordsPerLine === 0) {
                    xPos = 20;
                    yPos += 8;
                }
                
                doc.setTextColor(0, 0, 0);
                const prefix = withSolutions ? 'OK ' : '- ';
                doc.text(prefix + word, xPos, yPos);
                xPos += 60;
            });
            
            // Add line
            yPos += 12;
            doc.setDrawColor(42, 82, 152);
            doc.setLineWidth(0.5);
            doc.line(20, yPos, 190, yPos);
            
            // Word search grid
            if (wordSearchGame) {
                const cellSize = 7;
                const startY = yPos + 10;
                const gridWidth = wordSearchGame.cols * cellSize;
                
                // Center the grid
                const centerX = (210 - gridWidth) / 2;
                
                doc.setFontSize(9);
                doc.setTextColor(0, 0, 0);
                
                // Draw grid
                for (let i = 0; i < wordSearchGame.rows; i++) {
                    for (let j = 0; j < wordSearchGame.cols; j++) {
                        const x = centerX + j * cellSize;
                        const y = startY + i * cellSize;
                        
                        // Draw cell border
                        doc.setDrawColor(150, 150, 150);
                        doc.rect(x, y, cellSize, cellSize);
                        
                        // Add letter
                        doc.text(wordSearchGame.board[i][j], x + cellSize/2, y + cellSize/2 + 2, {
                            align: 'center'
                        });
                    }
                }
            }
            
            // Save the PDF
            doc.save('CaçaPalavras_Geodesia_' + topic + '.pdf');
        }

        // Initialize word search game
        function initWordSearch(topic) {
            const data = wordSearchData[topic];
            wordsearchWordsDiv.innerHTML = '';
            
            // Create word list
            data.words.forEach(word => {
                const wordDiv = document.createElement('div');
                wordDiv.className = 'wordsearch-word';
                wordDiv.textContent = word;
                wordDiv.dataset.word = word;
                wordsearchWordsDiv.appendChild(wordDiv);
            });
            
            // Initialize game
            wordSearchGame = new WordSearchGame(15, 15, data.words);
            wordSearchGame.renderBoard(wordsearchBoard);
        }

        // Word Search Game Class
        class WordSearchGame {
            constructor(rows, cols, words) {
                this.rows = rows;
                this.cols = cols;
                this.words = words;
                this.board = [];
                this.selectedCells = [];
                this.foundWords = [];
                this.isDragging = false;
                this.placedWords = []; // Track where words are placed
                
                this.initBoard();
                this.placeWords();
                this.fillEmptyCells();
            }
            
            initBoard() {
                for (let i = 0; i < this.rows; i++) {
                    this.board[i] = [];
                    for (let j = 0; j < this.cols; j++) {
                        this.board[i][j] = '';
                    }
                }
            }
            
            placeWords() {
                const directions = [
                    { dr: 0, dc: 1 },   // Horizontal
                    { dr: 1, dc: 0 },   // Vertical
                    { dr: 1, dc: 1 },   // Diagonal \
                    { dr: 1, dc: -1 }   // Diagonal /
                ];
                
                this.placedWords = []; // Reset placed words tracking
                
                this.words.forEach(word => {
                    let placed = false;
                    let attempts = 0;
                    const maxAttempts = 200; // Increase attempts
                    
                    while (!placed && attempts < maxAttempts) {
                        attempts++;
                        
                        // Choose random direction
                        const dir = directions[Math.floor(Math.random() * directions.length)];
                        
                        // Choose random starting position
                        let r, c;
                        
                        if (dir.dc === 1) { // Horizontal
                            r = Math.floor(Math.random() * this.rows);
                            c = Math.floor(Math.random() * (this.cols - word.length + 1));
                        } else if (dir.dr === 1 && dir.dc === 0) { // Vertical
                            r = Math.floor(Math.random() * (this.rows - word.length + 1));
                            c = Math.floor(Math.random() * this.cols);
                        } else if (dir.dr === 1 && dir.dc === 1) { // Diagonal \
                            r = Math.floor(Math.random() * (this.rows - word.length + 1));
                            c = Math.floor(Math.random() * (this.cols - word.length + 1));
                        } else { // Diagonal /
                            r = Math.floor(Math.random() * (this.rows - word.length + 1));
                            c = Math.floor(Math.random() * (this.cols - word.length)) + word.length - 1;
                        }
                        
                        // Check if word fits
                        let fits = true;
                        for (let i = 0; i < word.length; i++) {
                            const nr = r + dir.dr * i;
                            const nc = c + dir.dc * i;
                            
                            // Check bounds
                            if (nr < 0 || nr >= this.rows || nc < 0 || nc >= this.cols) {
                                fits = false;
                                break;
                            }
                            
                            if (this.board[nr][nc] !== '' && this.board[nr][nc] !== word[i]) {
                                fits = false;
                                break;
                            }
                        }
                        
                        // Place word if it fits
                        if (fits) {
                            const wordPosition = [];
                            for (let i = 0; i < word.length; i++) {
                                const nr = r + dir.dr * i;
                                const nc = c + dir.dc * i;
                                this.board[nr][nc] = word[i];
                                wordPosition.push({row: nr, col: nc});
                            }
                            this.placedWords.push({
                                word: word,
                                positions: wordPosition
                            });
                            placed = true;
                        }
                    }
                    
                    // If word couldn't be placed after max attempts, place it forcefully
                    if (!placed) {
                        // Try horizontal placement in first available space
                        for (let r = 0; r < this.rows && !placed; r++) {
                            for (let c = 0; c <= this.cols - word.length && !placed; c++) {
                                let canPlace = true;
                                for (let i = 0; i < word.length; i++) {
                                    if (this.board[r][c + i] !== '' && this.board[r][c + i] !== word[i]) {
                                        canPlace = false;
                                        break;
                                    }
                                }
                                if (canPlace) {
                                    const wordPosition = [];
                                    for (let i = 0; i < word.length; i++) {
                                        this.board[r][c + i] = word[i];
                                        wordPosition.push({row: r, col: c + i});
                                    }
                                    this.placedWords.push({
                                        word: word,
                                        positions: wordPosition
                                    });
                                    placed = true;
                                }
                            }
                        }
                    }
                });
            }
            
            fillEmptyCells() {
                const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
                for (let i = 0; i < this.rows; i++) {
                    for (let j = 0; j < this.cols; j++) {
                        if (this.board[i][j] === '') {
                            this.board[i][j] = letters[Math.floor(Math.random() * letters.length)];
                        }
                    }
                }
            }
            
            renderBoard(container) {
                container.innerHTML = '';
                container.style.gridTemplateColumns = `repeat(${this.cols}, 1fr)`;
                
                for (let i = 0; i < this.rows; i++) {
                    for (let j = 0; j < this.cols; j++) {
                        const cell = document.createElement('div');
                        cell.className = 'wordsearch-cell';
                        cell.textContent = this.board[i][j];
                        cell.dataset.row = i;
                        cell.dataset.col = j;
                        
                        // Mouse events for desktop
                        cell.addEventListener('mousedown', (e) => {
                            e.preventDefault();
                            this.isDragging = true;
                            this.resetSelection();
                            this.toggleCellSelection(cell);
                        });
                        
                        cell.addEventListener('mouseenter', () => {
                            if (this.isDragging) {
                                this.toggleCellSelection(cell);
                            }
                        });
                        
                        cell.addEventListener('mouseup', () => {
                            this.isDragging = false;
                            this.checkSelectedWord();
                        });
                        
                        // Touch events for mobile
                        cell.addEventListener('touchstart', (e) => {
                            e.preventDefault();
                            this.isDragging = true;
                            this.resetSelection();
                            this.toggleCellSelection(cell);
                        });
                        
                        cell.addEventListener('touchmove', (e) => {
                            if (this.isDragging) {
                                const touch = e.touches[0];
                                const element = document.elementFromPoint(touch.clientX, touch.clientY);
                                if (element && element.classList.contains('wordsearch-cell')) {
                                    this.toggleCellSelection(element);
                                }
                            }
                        });
                        
                        cell.addEventListener('touchend', () => {
                            this.isDragging = false;
                            this.checkSelectedWord();
                        });
                        
                        container.appendChild(cell);
                    }
                }
            }
            
            toggleCellSelection(cell) {
                const row = parseInt(cell.dataset.row);
                const col = parseInt(cell.dataset.col);
                const index = this.selectedCells.findIndex(c => c.row === row && c.col === col);
                
                if (index === -1) {
                    // Only allow selection if it's in a straight line from the first cell
                    if (this.selectedCells.length === 0 || this.isInLine(this.selectedCells[0], {row, col})) {
                        this.selectedCells.push({ row, col });
                        cell.classList.add('selected');
                    }
                } else {
                    this.selectedCells.splice(index, 1);
                    cell.classList.remove('selected');
                }
            }
            
            isInLine(firstCell, newCell) {
                if (this.selectedCells.length === 0) return true;
                
                // Check if the new cell is in line with the first selected cell
                const dx = newCell.col - firstCell.col;
                const dy = newCell.row - firstCell.row;
                
                // Same row or same column or diagonal
                return (dx === 0 || dy === 0 || Math.abs(dx) === Math.abs(dy));
            }
            
            resetSelection() {
                this.selectedCells.forEach(cell => {
                    const cellElement = document.querySelector(`.wordsearch-cell[data-row="${cell.row}"][data-col="${cell.col}"]`);
                    if (cellElement && !cellElement.classList.contains('found')) {
                        cellElement.classList.remove('selected');
                    }
                });
                this.selectedCells = [];
            }
            
            checkSelectedWord() {
                if (this.selectedCells.length < 2) return;
                
                // Sort selected cells
                this.selectedCells.sort((a, b) => {
                    if (a.row !== b.row) return a.row - b.row;
                    return a.col - b.col;
                });
                
                // Determine direction
                const first = this.selectedCells[0];
                const last = this.selectedCells[this.selectedCells.length - 1];
                
                let dr = last.row - first.row;
                let dc = last.col - first.col;
                
                // Normalize direction
                if (dr !== 0) dr = dr / Math.abs(dr);
                if (dc !== 0) dc = dc / Math.abs(dc);
                
                // Check if selection is in a straight line
                for (let i = 1; i < this.selectedCells.length; i++) {
                    const prev = this.selectedCells[i-1];
                    const curr = this.selectedCells[i];
                    
                    const expectedRow = prev.row + dr;
                    const expectedCol = prev.col + dc;
                    
                    if (curr.row !== expectedRow || curr.col !== expectedCol) {
                        this.resetSelection();
                        return;
                    }
                }
                
                // Get the word from the selection
                let word = '';
                this.selectedCells.forEach(cell => {
                    word += this.board[cell.row][cell.col];
                });
                
                // Check if word is in the list (both directions)
                const reversedWord = word.split('').reverse().join('');
                let foundWord = null;
                
                if (this.words.includes(word)) {
                    foundWord = word;
                } else if (this.words.includes(reversedWord)) {
                    foundWord = reversedWord;
                }
                
                if (foundWord && !this.foundWords.includes(foundWord)) {
                    // Mark as found
                    this.foundWords.push(foundWord);
                    
                    // Update UI
                    document.querySelectorAll('.wordsearch-word').forEach(wordDiv => {
                        if (wordDiv.dataset.word === foundWord) {
                            wordDiv.classList.add('found');
                        }
                    });
                    
                    // Highlight cells
                    this.selectedCells.forEach(cell => {
                        const cellElement = document.querySelector(`.wordsearch-cell[data-row="${cell.row}"][data-col="${cell.col}"]`);
                        cellElement.classList.remove('selected');
                        cellElement.classList.add('found');
                    });
                    
                    // Check if all words are found
                    if (this.foundWords.length === this.words.length) {
                        setTimeout(() => {
                            alert('Parabéns! Você encontrou todas as palavras!');
                        }, 300);
                    }
                }
                
                this.resetSelection();
            }
        }
    </script>
</body>
</html>